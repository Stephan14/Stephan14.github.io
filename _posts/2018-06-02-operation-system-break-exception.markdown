---
layout:     post
title:      "中断与异常机制"
subtitle:   "中断与异常的详细介绍"
date:       2018-06-02 23:34:00
author:     "邹盛富"
header-img: "img/1525878978225.jpg"
tags:
    - 操作系统
---
### 软件与硬件的工作
中断、异常机制实际上是现代计算机系统中的核心机制之一，主要工作是由硬件和软件相互配合来完成的，通过软硬件的配合使计算机的能力得到充分地发挥。在这个机制工作过程中，硬件实际上是捕获中断源发出的各种中断、异常的请求，同时把控制权转交给特定的处理程序来完成这个过程，称这个过程为**中断异常的响应**。软件的工作就是识别中断啊、异常类型完成对应的处理，实际上就是处理程序，称这个程序**为中断、异常处理程序**。 所以硬件完成的是响应，软件完成的是处理。

中断响应就是发现中断、接收中断的一个过程，这个过程是由中断的硬件部件完成，在处理器控制部件当中设置了一个**中断寄存器**，保存了发来的各种各样的中断信号。如下图所示![](http://res.cloudinary.com/bytedance14/image/upload/v1527955715/blog/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7_2018-06-03_%E4%B8%8A%E5%8D%8812.05.55.png)当CPU取下一条指令，然后执行这条指令，在执行完这条指令之后（也就是在每条指令周期的最后），扫描中断寄存器，查看是否有中断发生即是否有中断信号，如果有中断信号，就要对中断进行相应的处理，会把它的内容按规定编码送到程序状态字寄存器当中的相应的位，称该编码为**中断码**。然后查中断向量表，把中断处理程序调用出来，然后下一个指令周期执行相应的中断处理指令。

### 中断向量表

硬件会根据中断寄存器中的中断码查询中断向量表，中断向量表实际上是个非常重要的软硬件结合的一个数据结构。中断向量表中每一行实际上是一个中断向量，中断向量表是由若干行中断向量组成，每一个中断向量其实就是一个内存单元，它是存放了中断处理程序的**入口地址**以及中断程序在运行的时候所需要的一个**处理机的状态字**，若干中断向量构成了中断向量表。那么，操作系统需要把填写事先先写好的中断处理程序并把这些中断处理程序的起始地址（入口地址），填在中断向量表里头。那么当中断发生的时，那么执行流程就会按照中断码/异常类型的不同，通过中断向量表把控制权转移给对应的中断处理程序。Linux中的中断向量表如下：
![](http://res.cloudinary.com/bytedance14/image/upload/v1528091953/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7_2018-06-04_%E4%B8%8B%E5%8D%881.57.48.png)

### 中断响应过程

流程图如下：
![](http://res.cloudinary.com/bytedance14/image/upload/v1528124660/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7_2018-06-04_%E4%B8%8B%E5%8D%8811.03.15.png)

- 设备发来了中断信号
- **中断硬件**会去保存现场(保存到系统堆栈)，主要的是PSW加PC
- 中断硬件根据中断码来去查中断向量表，通过查中断向量表得到对应的中断处理程序
- 把中断处理程序的入口地址等相关信息，推送到相应的寄存器，那么下一个指令周期开始，执行中断处理程序

### 中断处理程序

中断处理程序的主要工作：
- 保存相关寄存器信息
- 分析相关异常的具体原因
- 执行对应处理程序
- 恢复现场，返回被事件打断的程序

### 总结

![](http://res.cloudinary.com/bytedance14/image/upload/v1528127457/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7_2018-06-04_%E4%B8%8B%E5%8D%8811.21.01.png)
![](http://res.cloudinary.com/bytedance14/image/upload/v1528127472/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7_2018-06-04_%E4%B8%8B%E5%8D%8811.23.31.png)
